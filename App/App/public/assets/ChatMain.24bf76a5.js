import{_ as x,l as T,as as V,m as b,n as O,p as o,q as f,s as r,f as i,V as S,a2 as m,X as n,a3 as B,R as q,S as u,aw as _,U as A,F as y,t as P,a8 as N,a9 as L,aa as F}from"./index.30bcee2d.js";import{Q as W}from"./QToolbarTitle.80059bbe.js";import{Q as z}from"./QToolbar.8b90f7d3.js";import{Q as H}from"./QHeader.b4bada8e.js";import{Q as X}from"./QSpace.274cde1f.js";import{Q as D}from"./QItemLabel.b935a34d.js";import{Q as G}from"./QList.d8ad41f7.js";import{Q as J}from"./QPageScroller.8d9fce0a.js";import{Q as K}from"./QPage.f04658ef.js";import{Q as Y}from"./QPullToRefresh.e8308158.js";import{c as v,f as w,b as p,q as C,w as Q,o as I,l as U,h as M,g as R}from"./FirebaseChat.f9ca35c9.js";import{d as Z}from"./date.664e3d0e.js";import"./QResizeObserver.3c3b4a7a.js";import"./use-page-sticky.73584e0a.js";import"./touch.3df10340.js";import"./selection.c88e3f6c.js";import"./format.2bc25e5f.js";const $={name:"ChatMain",components:{ChatSearch:T(()=>P(()=>import("./ChatSearch.08dbeaea.js"),["assets/ChatSearch.08dbeaea.js","assets/index.30bcee2d.js","assets/index.aba08127.css","assets/QSpace.274cde1f.js","assets/QToolbar.8b90f7d3.js","assets/ClosePopup.da855ff7.js","assets/FirebaseChat.f9ca35c9.js"])),ChatUserLoader:T(()=>P(()=>import("./ChatUserLoader.72bad7ba.js"),["assets/ChatUserLoader.72bad7ba.js","assets/QSkeleton.8077f081.js","assets/index.30bcee2d.js","assets/index.aba08127.css","assets/QItemLabel.b935a34d.js","assets/QList.d8ad41f7.js"]))},data(){return{user_uuid:"",data:[],users:[],all_users:[],users_data:[],loading:!1,loading_user:!1,last_message_data:{},whoistyping_data:{},document_id:"",main_user_type:"",refresh_page:void 0}},mounted(){let e=V.getUser();this.user_uuid=e.client_uuid,this.getParticipants()},computed:{getData(){return this.data},getLastMessageData(){return this.last_message_data},hasData(){return Object.keys(this.data).length>0},hasUserData(){return Object.keys(this.users_data).length>0},getShowistyping(){return this.whoistyping_data}},methods:{refresh(e){this.refresh_page=e,this.getParticipants()},getParticipants(){try{this.loading=!0;const e=v(w,p.chats),l=C(e,Q("participants","array-contains",this.user_uuid),I("lastUpdated","desc"),U(p.limit)),k=M(l,c=>{this.data=[],this.users=[],this.all_users=[],this.loading=!1,b.empty(this.refresh_page)||this.refresh_page(),c.forEach(s=>{let a=s.data(),h=a.isTyping||null,d=a.participants||null;if(d){Object.keys(d).length>0&&Object.entries(d).forEach(([E,j])=>{this.all_users.push(j)});let t=d.filter(E=>!E.includes(this.user_uuid)),g=t[0]?t[0]:null;this.users.push(g),this.data.push({doc_id:s.id,user_uuid:g,is_typing:h[t[0]]?h[t[0]]:!1,orderID:a.orderID||null,orderUuid:a.orderUuid||null})}}),Object.keys(this.users).length>0&&(this.getUser(),this.getLastMessage(),this.getWhoIsTyping())},c=>{this.loading=!1,b.empty(this.refresh_page)||this.refresh_page(),console.log("Error fetching chat documents:",c)})}catch(e){b.notify("dark",e,"error",this.$q)}},showSearch(){this.$refs.chat_search.dialog=!0},loadConversation(e){this.$router.push({path:"/account/chat/conversation",query:{doc_id:e}})},getUser(){this.loading_user=!0,b.fetchDataChats("getUsers",{main_user_type:this.main_user_type,users:this.users}).then(e=>{this.users_data=e.details}).catch(e=>{this.users_data=[]}).then(e=>{this.loading_user=!1})},async getLastMessage(){try{const e=this.all_users.splice(0,10),l=v(w,p.chats);(await R(C(l,Q("participants","array-contains-any",this.users)))).forEach(async c=>{const s=c.id,a=v(w,p.chats,s,"messages");(await R(C(a,Q("senderID","in",e),I("timestamp","desc"),U(1)))).forEach(d=>{let t=d.data(),g=t.timestamp.toDate().toISOString();this.last_message_data[s]={message:t.message,timestamp:g,time:Z.formatDate(g,"hh:mm a")}})})}catch(e){console.error("Error fetching last message:",e)}},async getWhoIsTyping(){const e=C(v(w,p.chats),Q("participants","array-contains-any",this.users),I("lastUpdated","desc"),U(p.limit));M(e,l=>{l.forEach(k=>{let s=k.data().isTyping||[];Object.keys(s).length>0&&Object.entries(s).forEach(([a,h])=>{this.whoistyping_data[a]=h})})})},isTyping(e){return Object.keys(this.whoistyping_data).length>0&&this.whoistyping_data[e]||!1}}},ee={class:"q-pl-md q-pr-md"},te={class:"border-grey bg-grey-1 radius8"},ae={key:0,class:"text-body2 text-weight-medium flex flex-center text-grey",style:{height:"calc(80vh)"}},se=["src"],re={key:0,class:"text-primary"},ie={key:0,class:"time"};function oe(e,l,k,c,s,a){const h=O("ChatUserLoader"),d=O("ChatSearch");return o(),f(Y,{onRefresh:a.refresh},{default:r(()=>[i(H,{reveal:"","reveal-offset":"20",class:B({"bg-mydark text-white":e.$q.dark.mode,"bg-white text-dark":!e.$q.dark.mode})},{default:r(()=>[i(z,null,{default:r(()=>[i(S,{onClick:l[0]||(l[0]=t=>e.$router.back()),flat:"",round:"",dense:"",icon:"las la-angle-left",class:"q-mr-sm",color:e.$q.dark.mode?"white":"dark"},null,8,["color"]),i(W,{class:"text-weight-bold"},{default:r(()=>[m(n(e.$t("Live Chat")),1)]),_:1})]),_:1})]),_:1},8,["class"]),i(K,null,{default:r(()=>[q("div",ee,[q("div",te,[i(S,{label:e.$t("Search restaurants"),"no-caps":"",color:e.$q.dark.mode?"grey600":"grey-1","text-color":e.$q.dark.mode?"grey300":"grey",icon:"search",unelevated:"",align:"left",class:"fit radius8",onClick:a.showSearch},null,8,["label","color","text-color","onClick"])])]),i(X,{class:"q-pa-sm"}),!a.hasData&&!s.loading?(o(),u("div",ae,n(e.$t("Search to chat with restaurants")),1)):_("",!0),s.loading?(o(),f(h,{key:1,rows:10})):_("",!0),a.hasData&&!s.loading&&a.hasUserData?(o(),f(G,{key:2},{default:r(()=>[(o(!0),u(y,null,A(a.getData,t=>(o(),u(y,{key:t},[s.users_data[t.user_uuid]?(o(),f(N,{key:0,clickable:"",onClick:g=>a.loadConversation(t.doc_id)},{default:r(()=>[i(L,{avatar:""},{default:r(()=>[i(F,null,{default:r(()=>[q("img",{src:s.users_data[t.user_uuid].photo_url},null,8,se)]),_:2},1024)]),_:2},1024),i(L,null,{default:r(()=>[i(D,{class:"text-weight-bold"},{default:r(()=>[m(n(s.users_data[t.user_uuid].first_name)+" "+n(s.users_data[t.user_uuid].last_name),1)]),_:2},1024),i(D,{caption:""},{default:r(()=>[t.orderID?(o(),u(y,{key:0},[m(n(e.$t("Order#"))+" "+n(t.orderID),1)],64)):(o(),u(y,{key:1},[m(n(s.users_data[t.user_uuid].user_type),1)],64))]),_:2},1024),a.getLastMessageData[t.doc_id]?(o(),f(D,{key:0,caption:"",lines:"2"},{default:r(()=>[a.isTyping(t.user_uuid)?(o(),u("span",re,n(s.users_data[t.user_uuid].first_name)+" is typing ...",1)):(o(),u(y,{key:1},[m(n(a.getLastMessageData[t.doc_id].message),1)],64))]),_:2},1024)):_("",!0)]),_:2},1024),i(L,{side:""},{default:r(()=>[i(D,{caption:"",lines:"2",class:"text-center"},{default:r(()=>[a.getLastMessageData[t.doc_id]?(o(),u("div",ie,n(a.getLastMessageData[t.doc_id].time),1)):_("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])):_("",!0)],64))),128))]),_:1})):_("",!0),a.hasData&&!s.loading&&a.hasUserData?(o(),f(J,{key:3,position:"bottom-right","scroll-offset":150,offset:[18,18]},{default:r(()=>[i(S,{fab:"",icon:"keyboard_arrow_up",color:"primary",padding:"sm"})]),_:1})):_("",!0)]),_:1}),i(d,{ref:"chat_search"},null,512)]),_:1},8,["onRefresh"])}var Ce=x($,[["render",oe]]);export{Ce as default};
